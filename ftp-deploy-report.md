# Отчет по анализу проблем с FTP-деплоем

## Результаты анализа

На основе предоставленной информации и созданных инструментов выявлены следующие проблемы с FTP-деплоем из GitHub Actions:

1. **Основная проблема**: Таймаут соединения FTP при длительной загрузке файлов (ошибка "Timeout (control socket)").

2. **Возможные причины**:
   - Недостаточный таймаут по умолчанию (30 секунд)
   - Возможная несовместимость с пассивным режимом FTP
   - Потенциальная поддержка только SFTP на стороне хостинга
   - Проблемы с сетевыми настройками или брандмауэром

3. **Созданные инструменты для диагностики**:
   - `test-ftp-connection.php` - для проверки FTP-соединения и выявления проблем
   - `test-sftp-connection.php` - для проверки поддержки SFTP
   - Обновленный файл конфигурации GitHub Actions с оптимизированными настройками
   - Подробные инструкции по решению проблем в `ftp-deploy-instructions.txt`

## Рекомендации по решению

### Вариант 1: Оптимизация FTP-деплоя

1. **Используйте обновленный файл конфигурации**.
   - Увеличенный таймаут до 120000 мс (2 минуты)
   - Подробное логирование для выявления проблем
   - Оптимизированные исключения для уменьшения объема передаваемых данных

2. **Проверьте настройки FTP на хостинге**.
   - Убедитесь, что FTP-протокол работает на стандартном порту 21
   - Проверьте, не требуется ли особая конфигурация (например, активный режим)

3. **Оптимизируйте репозиторий**.
   - Исключите ненужные файлы из деплоя (node_modules, .git, временные файлы)
   - Убедитесь, что все файлы конфигурации БД исключены из деплоя

### Вариант 2: Переход на SFTP (рекомендуемый)

1. **Используйте SFTP вместо FTP**.
   - Раскомментируйте блок SFTP в конфигурации GitHub Actions
   - Закомментируйте блок FTP
   - Убедитесь, что хостинг поддерживает SFTP (обычно на порту 22)

2. **Проверьте подключение к SFTP**.
   - Используйте скрипт `test-sftp-connection.php` с реальными учетными данными
   - Убедитесь, что порт 22 открыт на хостинге

3. **Обновите секреты в репозитории**.
   - Используйте те же секреты (`FTP_SERVER`, `FTP_USERNAME`, `FTP_PASSWORD`) для SFTP

## Дополнительные рекомендации

1. **Мониторинг деплоя**:
   - Включите уведомления о результатах деплоя
   - Настройте простую проверку доступности сайта после деплоя

2. **Безопасность**:
   - Используйте отдельного пользователя FTP/SFTP для деплоя
   - Ограничьте права этого пользователя только необходимыми директориями

3. **Альтернативные методы деплоя**:
   - Если FTP/SFTP не работает стабильно, рассмотрите другие методы деплоя
   - Рассмотрите возможность настройки непрерывного развертывания на стороне хостинга

## Заключение

Основная проблема связана с таймаутами FTP-соединения при деплое. Рекомендуется:

1. Сначала попробовать обновленную конфигурацию FTP с увеличенным таймаутом
2. Если проблема сохраняется, перейти на SFTP (более надежный и безопасный протокол)
3. Использовать созданные инструменты для диагностики и устранения проблем

Инструменты и инструкции готовы к использованию. Для тестирования необходимо заполнить реальные данные FTP/SFTP в соответствующих тестовых скриптах. 